// The .github/workflows/check-issues.yml will use it as an github action

package main

import (
	"fmt"
	"os"
	"regexp"

	"github.com/go-rod/rod/lib/utils"
	"github.com/ysmood/kit"
)

const ref = "\n_<sub>generated by [check-issue](https://github.com/go-rod/rod/tree/master/lib/utils/check-issue)</sub>_"

func main() {
	data, err := kit.ReadFile(os.Getenv("GITHUB_EVENT_PATH"))
	utils.E(err)

	issue := kit.JSON(data).Get("issue")

	labels := issue.Get("labels").Array()

	for _, l := range labels {
		name := l.Get("name").Str
		if name != "question" && name != "bug" {
			kit.Log("skip", name)
			return
		}
	}

	num := issue.Get("number").Int()
	body := issue.Get("body").Str

	kit.Log("check issue", num)

	m := regexp.MustCompile(`\*\*Rod Version:\*\* v[0-9.]+`).FindString(body)
	if m == "" || m == "**Rod Version:** v0.0.0" {
		kit.Log("invalid issue format", body)

		msg := fmt.Sprintf(
			"Please add a valid `**Rod Version:** v0.0.0` to your issue. Current version is %s"+
				ref,
			currentVer(),
		)

		q := req(fmt.Sprintf("/repos/go-rod/rod/issues/%d/comments", num)).
			Post().
			JSONBody(map[string]string{"body": msg})

		if q.MustResponse().StatusCode >= 400 {
			panic(q.MustString())
		}
	}
}

func currentVer() string {
	currentVer := req("/repos/go-rod/rod/releases").
		Query("per_page", "1").
		MustJSON().Get("0.tag_name").Str

	kit.Log("current rod version", currentVer)
	return currentVer
}

func req(u string) *kit.ReqContext {
	return kit.Req("https://api.github.com"+u).Header("Authorization", "token "+os.Getenv("GH_ROBOT_TOKEN"))
}
